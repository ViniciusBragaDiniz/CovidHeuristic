<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <title>Google Maps API</title>
    <style>
        h1 {
            font-size: 16pt;
        }
        #map{
            display: block;
            height: 400px;
            width: 100%;
        }
        div#side-bar {
            height: 400px;
        }

        input[type=number]{
            width: 100px;
        }

        #confirmar {
            float: right;
        }
    </style>
</head>
<body>

    <div class="container">
        Raio de busca (em metros): <input class="form-control" type="number" name="radius" id="radius">
        Filtro: <select class="form-control mb-2" name="filtro" id="filtro">
            <option value="stadium">Estádios</option>
            <option value="hospital">Hospitais</option>
        </select>

        <button id="submit" class="btn btn-success" onclick="ajax()">Gerar CSV</button>
        <button id="submit" class="btn btn-warning" onclick="clearResults()">Limpar</button>


        <h1>Mapa (clique com o botão esquerdo do mouse adicionar os estabelecimentos na lista)</h1>
        <div id="content" class="row">
            <div class="col-6" id="map"></div>
            <div class="col-6 overflow-auto" id="side-bar">
                <table class="table" id="lista">
                    
                </table>
            </div>
        </div>
        <button id="confirmar" class="btn btn-primary mt-2" onclick="confirmarTodos()" type="button">Confirmar Todos</button>


    </div>

    <script src="https://code.jquery.com/jquery-3.4.1.slim.js" integrity="sha256-BTlTdQO9/fascB1drekrDVkaKd9PkwBymMlHOiG+qLI=" crossorigin="anonymous"></script>
    <script src="js/axios.js"></script>
    <script>

        /*$(document).click(function() {
            $("#side-bar").toggle('slide')
        })*/
        /*document.body.onload = async e => {
            const resultado = await axios("http://localhost:3300/refri")
                .catch(err => console.log(err))
            console.log(resultado)
        }*/

        let map = null
        let infowindow = null
        let request = null
        let service = null
        let markers = []
        let filtro = null
        let busca = []
        function initMap() {

            const center = {lat: -22.9035 , lng: -43.2096}
            const div = document.querySelector('div#map')
            map = new google.maps.Map(div, {
                zoom: 10,
                center: center
            })

            /*request = { 
                location: center,
                radius: 100000,
                types: ['stadium']
            }*/

            infowindow = new google.maps.InfoWindow()
            service = new google.maps.places.PlacesService(map)


            //service.nearbySearch(request, callback)

            google.maps.event.addListener(map, 'rightclick', event => {
                let radius = parseFloat(document.querySelector('input#radius').value)
                let select = document.querySelector('select#filtro')
                filtro = select.options[select.selectedIndex].value
                let param = filtro
                //console.log(filtro, radius)
                map.setCenter(event.latLng)
                //clearResults(markers)
                request = {
                    fields: ['name', 'vicinity', 'plus_code'],
                    location: event.latLng,
                    radius: radius,
                    types: [filtro]
                }

                service.nearbySearch(request, callback)

            })
        }

        async function callback(results, status) {
            if(status == google.maps.places.PlacesServiceStatus.OK) {
                
                //console.log(results)
                results.forEach(place => {
                    //console.log(place)
                    markers.push(createMarker(place))
                    let existe = busca.find(element => element.id === place.id)
                    console.log(existe)
                    if(!existe) {
                        busca.push(place)
                    }else {
                        console.log('Já existe')
                    }
                })
                console.log(busca)
                
                gerarLista()
                /*const resposta = await axios.post('/construirCSV', {lugares: results, filtro})
                console.log(resposta)
                alert(resposta.data)*/
            }
        }

        function createMarker(place) {
            const placeLoc = place.geometry.location
            const marker = new google.maps.Marker({
                map: map,
                position: placeLoc
            })

            google.maps.event.addListener(marker, 'click', () => {
                infowindow.setContent(place.name)
                infowindow.open(map, marker)
            })
            return marker
        }

        function clearResults(){
            markers.forEach(marker => marker.setMap(null))
            markers = []
            busca = []
            gerarLista()
        }

        function gerarLista() {
            const tabela = document.getElementById('lista') 
            tabela.innerHTML = `<tr>
                            <td>Nome</td>
                            <td>Custo</td>
                            <td>Cobertura</td>
                            <td>Confirmar</td>
                            <td>Deletar</td>
                        </tr>`
            busca.forEach(lugar => {
                const linha = document.createElement('tr')
                linha.innerHTML = `<td>${lugar.name}</td>
                <td> 
                    <input type="number" size="3pt" id='txtCusto${lugar.id}' name="custo">
                </td>
                <td> 
                    <input type="number" size="3pt" id='txtCobertura${lugar.id}' name="cobertura">
                </td>
                <td><button class="btn btn-primary" type="button" onclick="confirmar('${lugar.id}')">Confirmar</button></td>
                <td><button class="btn btn-danger" onclick="remover('${lugar.id}')" type="button">Deletar</button></td>`
                tabela.append(linha)
            })
            
        }

        function confirmar(id) {
            const indice = busca.indexOf(busca.find(element => {
                if(element)
                    return element.id === id
                else
                    return false
            }))

            const custo = document.querySelector(`#txtCusto${busca[indice].id}`).value
            const cobertura = document.querySelector(`#txtCobertura${busca[indice].id}`).value
            busca[indice].custo = parseFloat(custo)
            busca[indice].cobertura = parseInt(cobertura)
            //console.log(busca[indice])
        }

        function confirmarTodos() {
            busca.forEach(lugar => {
                if(lugar) {
                    const custo = document.querySelector(`#txtCusto${lugar.id}`).value
                    const cobertura = document.querySelector(`#txtCobertura${lugar.id}`).value
                    lugar.custo = parseFloat(custo)
                    lugar.cobertura = parseInt(cobertura)
                }
            })
            console.log(busca)
        }

        function remover(id) {
            const indice = busca.indexOf(busca.find(element => {
                if(element)
                    return element.id === id
                else
                    return false
                }))
            console.log('Remoção', busca[indice])
            markers.forEach(marker => {
                if(marker.position === busca[indice].geometry.location){
                    console.log('Achei')
                    marker.setMap(null)
                }
            })
            delete busca[indice]
            console.log(busca)
            gerarLista()
        }

        async function ajax() {
            const resposta = await axios.post('http://localhost:3000/construirCSV', {lugares: busca})
                console.log(resposta)
                alert(resposta.data)
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyBofqU_V-dLDeMwfha5K8RcYwxwABYD_tY&callback=initMap"
    type="text/javascript"></script>
    
</body>
</html>